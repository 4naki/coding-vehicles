@name ACF Controller By Naki
@inputs Base:entity Ignition Throttle Reverse GearUp GearDown HandBreak RPM FullThrottle Brake
@outputs DisableCutoff Gear Clutch ThrottleOut HandBreakOut BrakeOut Power

@persist DisableCutoff Gears Gear BrakePower SaveGear ShiftSpeed Clutch Shifting StartingSound:string StartingTime IdleRPM ThrottleOut Power Stalling HandBreakOut BrakeOut
if(first()){
    DisableCutoff = 1
    
    BrakePower=1
    
    IdleRPM = 950
    
    Gears=6
    
    ShiftSpeed=360
    
    StartingSound="acf_extra/vehiclefx/starters/starter3.wav"
    StartingTime=1600
    
    Stalling=0
}

interval(100)

if(changed(Ignition)&Ignition){
    if(Power){
        Power=0
    }else{
        timer("start",StartingTime)
        Base:soundPlay("starter",0,StartingSound)
        Spat=1
    }
}
if(clk("start")){
    Power=1
}
if(Stalling){
    if(RPM<IdleRPM*1.1){
        if(Power*!Clutch*(Gear>0)*!HandBreakOut){
            Power=0
        }
    }
}

if(HandBreak){
    Clutch=1
    HandBreakOut=1
}

if(changed(HandBreak)&!HandBreak){
    Clutch=0
    HandBreakOut=0
}

if(changed(Reverse)){
    if(!Reverse){
        Gear=SaveGear
    }
}
if(Reverse){
    Gear=Gears+1
}else{
    if(Shifting==0){
    if(changed(GearUp)&GearUp){
        if(Gear<Gears){
            Shifting=1
            SaveGear=Gear
            Clutch=1
            timer("shiftup",ShiftSpeed)
            timer("shift",ShiftSpeed/3)
        }
    }
    
    if(changed(GearDown)&GearDown){
        if(Gear>0){
            Shifting=1
            SaveGear=Gear
            Clutch=1
            timer("shiftdown",ShiftSpeed)
            timer("shift",ShiftSpeed/3)
        }
    }
    }
    if(clk("shift")){
        Gear=0
    }
    
    if(clk("shiftup")){
        SaveGear+=1
        Gear=SaveGear
        Clutch=0
        Shifting=0
    }
    if(clk("shiftdown")){
        SaveGear-=1
        Gear=SaveGear
        Clutch=0
        Shifting=0
    }
}
BrakeOut=BrakePower*Brake
ThrottleOut=(clamp(((76*Throttle)-(RPM/500)+(45*FullThrottle*Throttle))+(10*Gear>0),0,100))*!Shifting

if(dupefinished()){
    reset()
}
