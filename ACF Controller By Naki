@name ACF Controller By Naki
@inputs Base:entity Ignition Throttle Reverse GearUp GearDown HandBreak RPM FullThrottle
@outputs DisableCutoff Gears Gear BreakPower SaveGear ShiftSpeed Clutch Shifting StartingSound:string StartingTime IdleRPM MinRPM MaxRPM LimitRPM ThrottleOut Power Stalling HandBreakOut

@persist DisableCutoff Gears Gear BreakPower SaveGear ShiftSpeed Clutch Shifting StartingSound:string StartingTime IdleRPM MinRPM MaxRPM LimitRPM ThrottleOut Power Stalling HandBreakOut
if(first()){
    DisableCutoff = 1
    
    BreakPower=35
    
    IdleRPM = 950
    MinRPM = 4100
    MaxRPM = 8500
    LimitRPM = 10000
    
    Gears=5
    
    ShiftSpeed=480
    
    StartingSound="acf_extra/vehiclefx/starters/starter3.wav"
    StartingTime=1600
    
    Stalling=0
}

interval(100)

if(changed(Ignition)&Ignition){
    if(Power){
        Power=0
    }else{
        timer("start",StartingTime)
        Base:soundPlay("starter",0,StartingSound)
    }
}
if(clk("start")){
    Power=1
}
if(Stalling){
    if(RPM<IdleRPM*1.1){
        if(Power*!Clutch){
            Power=0
        }
    }
}

if(changed(HandBreak)&HandBreak){
    Clutch=1
    HandBreakOut=1
}

if(changed(HandBreak)&!HandBreak){
    Clutch=0
    HandBreakOut=0
}

if(changed(Reverse)){
    if(!Reverse){
        Gear=SaveGear
    }
}
if(Reverse){
    Gear=Gears+1
}else{
    if(Shifting==0){
    if(changed(GearUp)&GearUp){
        if(Gear<Gears){
            Shifting=1
            SaveGear=Gear
            Clutch=1
            timer("shiftup",ShiftSpeed)
            timer("shift",ShiftSpeed/3)
        }
    }
    
    if(changed(GearDown)&GearDown){
        if(Gear>0){
            Shifting=1
            SaveGear=Gear
            Clutch=1
            timer("shiftdown",ShiftSpeed)
            timer("shift",ShiftSpeed/3)
        }
    }
    }
    if(clk("shift")){
        Gear=0
    }
    
    if(clk("shiftup")){
        SaveGear+=1
        Gear=SaveGear
        Clutch=0
        Shifting=0
    }
    if(clk("shiftdown")){
        SaveGear-=1
        Gear=SaveGear
        Clutch=0
        Shifting=0
    }
}

ThrottleOut=(clamp(80-(RPM/500)+(45*FullThrottle),0,100)*(Throttle>0))/round(1+Clutch)
